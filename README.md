<h2>
This project is a work in progress. Please be patient. 
</h2>

# Router Log Monitor

The purpose of this project is to aid in the monitoring of logs generated by a Netgear R6400 router. I have configured it to email a log every day at midnight.

Every once in a while I would find evidence of an unauthorized access to the WiFi access point, or some other suspect activity. And not having time to look through logs every day I decided to automate the process.

There are two separate applications in this project. The first is written in PHP and its purpose is to download the log email messages and write their content to a log file. The second part is a Node.js application that watches and waits for new log files to be created. When one or more is detected this application will read the log file, parse it, and write the results to a database.

## Advantages

With all of the log entries parsed and saved in a database I will be able to get a much better view into what's been going on. And it will be much easier to detect and identify problems, and remedy them. Once I'm able to detect them I can even create notifications such as SMS or email. 

## Overview

The primary components are:

* A Netgear R6400 router configured to email its logs. I've set mine up to email the log daily at midnight.
* An email server, must be capable of IMAP.
* A LAMP stack server **located on your local network**. I'm using a NAS as my server. Something smaller like a Raspberry Pi B+ >=3 should also work.
* A web browser capable client on your local network.

<p align="center">
  <img src="./mdimg/netgear-log-tool-overview.png" alt="" txt="" width="80%">
</p>

### Features

* Configurable
  * IMAP server settings
  * Run by a cron job, processes the new log messages automatically.
  * **TBD**

## PHP vs. Node.js

<p align="center">
  <img src="./mdimg/scale-php_v_node.png" width="25%" height="25%" alt="Index Page" txt="PHP v Node" />
</p>

When I started the initial design of this project I investigated handling all of the imap interactions with JavaScript and Node.js. 

I did a lot of research on IMAP and the availability of libraries in NPMs or PHP. What I found kind of surprised me a bit. I *expected* that Node.js would have some up to date, and active NPMs available for use. But that's not what I found. 

* Some were unmaintained, it has been years since an issue was closed or code was updated.
* Some were just impractical. Like the self-hosted API and a library to interact with it.
* Some had a large code footprint, and were over complicated for simple use.

Please note that I am a *fan* of Node.js. I like it, I like coding for Node.js. And there are a lot of *good* NPM packages for it. But... sometimes a Node.js application is just too "fat" when compared to what it *actually does*. For example, one of the "proof of concept" applications I put together ended up using around 4 meg of space and it was only about a dozen lines of active code. Where? in the `node_modules` folder of course!

So I switched over to PHP and in a couple of hours I had something *working*. I can open the connection to the server, download headers, and download the header and message body, process the body and save it! And it *only* used about 10 **kilobytes** of code space. No extra libraries, no fluff, no unused deeply hidden stuff in `node_modules` either!

And in 99% of PHP installations the proper imap module is already there. And there's also better *compatibility* across versions of PHP. The same code I write when developing and testing under 5.6 will also work without modification under PHP7.2.

So for this particular application PHP makes more sense than JavaScript on Node.js. Well, at least for *part* of it. There is a Node.js side to this project. Its purpose will be to finish the processing and parsing of the files that were saved by the PHP side. It will also write the parsed data to a MySQL database and generate static report content each time it finishes processing a file.

# Application Architecture Overview 

## Log Collector

<p align="center">
  <img src="./mdimg/log-collector-arch.png" alt="Index Page" txt="PHP v Node"  width="80%" height="80%"/>
</p>

### Design

## Log Watcher-Processor

<p align="center">
  <img src="./mdimg/log-watcher-arch.png" alt="Index Page" txt="PHP v Node"  width="80%" height="80%"/>
</p>

### Design


## Database Schemas

### Log Record Types

* DHCP IP
* Dynamic DNS
* LAN access from remote
* Internet connected
* Internet disconnected
* Time synchronized with NTP server
* DoS attack: FIN Scan
* DoS attack: ACK Scan
* WLAN access rejected
* Initialized, firmware version
* Admin login

### Data Relationships

At first glance making sense of the log entry data seemed *simple*. But I don't believe now that is true. It seems likely that the best organization of the data would be into separate tables for *some of the log types. And perhaps some of them could be grouped into a single table. For example, the tables may be like this:

* Router Actions - 
  * Dynamic DNS
  * Internet connected
  * Internet disconnected
  * Time synchronized with NTP server
  * Admin login

* Router Invasion - 
  * DoS attack: FIN Scan
  * DoS attack: ACK Scan
  * WLAN access rejected

* Router LAN Activity - 
  * DHCP IP

* Router Updates - 
  * Initialized, firmware version 

* Network Activity - 
  * LAN access from remote

* ***TBD***

From the above it's clear that there are 5 *categories* and 11 *message types*. The following abbreviations will be used for each of the categories:

* Router Actions - **RA**
* Router Invasion - **RI**
* Router LAN Activity - **RL**
* Router Updates - **RU**
* Network Activity - **NA**
 
The following diagram illustrates the relationships of the message types to the data fields:

| Message Types                     | Category | Date | Time | IP Address | Port | Source IP | Source Port | MAC | Host | Message |
| --------------------------------- | -------- | ---- | ---- | ---------- | ---- | --------- | ----------- | --- | ---- | ------- |
| Admin login                       | RA       | X    | X    | X          |      |           |             |     |      |         |
| DHCP IP                           | RL       | X    | X    | X          |      |           |             | X   |      |         |
| DoS attack: FIN Scan              | RI       | X    | X    | X          |      |           |             |     |      | X       |
| DoS attack: ACK Scan              | RI       | X    | X    | X          |      |           |             |     |      |         |
| Dynamic DNS                       | RA       | X    | X    |            |      |           |             |     | X    | X       |
| Initialized, firmware version     | RU       | X    | X    |            |      |           |             |     |      | X       |
| Internet connected                | RA       | X    | X    | X          |      |           |             |     |      |         |
| Internet disconnected             | RA       | X    | X    |            |      |           |             |     |      |         |
| LAN access from remote            | NA       | X    | X    | X          | X    | X         | X           |     |      |         |
| Time synchronized with NTP server | RA       | X    | X    |            |      |           |             |     |      |         |
| WLAN access rejected              | RI       | X    | X    |            |      |           |             | X   |      | X       |

(*The table above was created using: [**Table to Markdown**](https://tabletomarkdown.com)*)

### Database Tables










---
<img src="http://webexperiment.info/extcounter/mdcount.php?id=router-log-monitor">